<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
	<title>Flappy bird clone with phaser engine</title>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/2.2.2/phaser.js"></script>

</head>
<body>

<script type="text/javascript">

(function () {

	'use strict';

	/*jslint browser: true*/
	/*global Phaser, console*/

	var game = new Phaser.Game(320, 480, Phaser.CANVAS, '', { preload: preload, create: create, update: update, render: render})
	,	bird
	,	pipes
	,	ground
	,	scoreWalls
	,	playButton
	, jump_sound
	,	scoreText
	,	timer
	, clickListener
	,	isRunning = false
	,	newGame = true
	,	score = 0
	,	spawnTime = 1500
	, PIPE_STARTING_X = 410
	,	PIPE_VELOCITY_X = -150
	,	BIRD_VELOCITY_Y = -450
	, PIPE_GAP = 180
	,	MAX_PIPE_HEIGHT = 480 - 64 - PIPE_GAP // Game size  - ground size - desired space between pipes
	,	PIPE_WIDTH = 100
	,	GROUND_SCROLL_SPEED = PIPE_VELOCITY_X;

	function preload() {

		game.scale.setShowAll();
		game.scale.setScreenSize();

		game.load.image('play_button', 'assets/play_button.png');
		game.load.image('sky', 'assets/sky.png');
		game.load.image('ground', 'assets/platform.png');
		game.load.spritesheet('bird', 'assets/birdsheet.png', 34, 24);
		game.load.image('pipe', 'assets/pipe.png');
		game.load.image('pipe-up', 'assets/pipe-up.png');
		game.load.image('pipe-down', 'assets/pipe-down.png');
		game.load.audio('jump', 'assets/flap.wav');

	}

	function create() {

		game.world.setBounds(0, 0, 500, 480);

		jump_sound = game.add.audio('jump');
		//  We're going to be using physics, so enable the Arcade Physics system
		game.physics.startSystem(Phaser.Physics.ARCADE);

		//  A simple background for our game
		var sky = game.add.tileSprite(0, 0, 320, 416, 'sky');

		pipes = game.add.group();
		pipes.createMultiple(20, 'pipe');

		scoreWalls = game.add.group();
		scoreWalls.enableBody = true;
		scoreWalls.createMultiple(10);

		scoreText = game.add.text(game.width / 2, 50, '0', { font: 'bold 32px arial', fill: '#FFF' });

		// The bird and its settings
		bird = game.add.sprite(game.width / 2, game.height / 2, 'bird');
		bird.scale.setTo(1.2)
		// Add and run the fly animation
		bird.animations.add('fly', [0, 1], 10, true);
		bird.animations.play('fly');
		bird.anchor.setTo(0.5, 0.5);
		game.physics.arcade.enable(bird);
		bird.body.gravity.y = 2000;
		bird.body.maxVelocity.setTo(500,800);
		bird.body.collideWorldBounds = true;
		bird.body.moves = false;

		ground = game.add.tileSprite(0, game.height - 64, game.width, 64, 'ground');
		ground.autoScroll(GROUND_SCROLL_SPEED, 0);
		game.physics.arcade.enable(ground);
		// This stops it from falling away when you jump on it
		ground.body.immovable = true;

		playButton = game.add.button(game.width/2 , game.height/2 , 'play_button',resetGame);
		playButton.anchor.setTo(0.5,0.5);

		clickListener = game.input.onDown.add(clicked);

		resetGame();
	}

	function update() {

		game.physics.arcade.collide(bird, ground, touchedPipe);

		if (isRunning) {

			game.physics.arcade.overlap(bird, scoreWalls, scoreIncr);
			game.physics.arcade.overlap(bird, pipes, touchedPipe);

			if (bird.body.velocity.y < 0 && bird.body.rotation > -20) {

				bird.body.rotation += -10;

			} else if (bird.body.velocity.y > 0 && bird.body.rotation < 90) {

				bird.body.rotation += 2;

			}

		}

	};

	function addPipes() {

		console.log("ADDING PIPE");
		var y = game.rnd.integerInRange(0,MAX_PIPE_HEIGHT)
				, pipeUp
				, pipeBottom
				, pipeUpHead
				, pipeBottomHead
				, scoreWall;

		pipeUp = addPipe(PIPE_STARTING_X,0,y);
		pipeUpHead = addPipe(PIPE_STARTING_X, pipeUp.height,0, 'pipe-down');
		pipeBottom = addPipe(PIPE_STARTING_X, game.height - 64 -(MAX_PIPE_HEIGHT - y ) , MAX_PIPE_HEIGHT - y);
		pipeBottomHead = addPipe(PIPE_STARTING_X,pipeBottom.y - 26, 0, 'pipe-up' );

		addScoreWall(pipeUp.height);

	}

	function addPipe (x,y,height, key) {

		x = x || PIPE_STARTING_X;
		y = y || 0;
		key = key || 'pipe';

		console.log('Creating a ' + key + ' at X:' + x + ' Y:' + y + ' ' + height);

		var pipePart  = pipes.getFirstDead();
		if(pipePart.key!==key){pipePart.loadTexture(key);console.log('(REMOVE) Texture not '+key)};

		pipePart.reset(x,y);
		if(height)pipePart.height = height;
		pipePart.width = PIPE_WIDTH;

		//physics settings
		game.physics.arcade.enable(pipePart);
		pipePart.body.immovable = true;
		pipePart.body.velocity.x = PIPE_VELOCITY_X;
		pipePart.checkWorldBounds = true;
		pipePart.outOfBoundsKill = true;

		return pipePart;

	}

	function addScoreWall (height) {

		var scoreWall = scoreWalls.getFirstDead();

		scoreWall.reset(PIPE_STARTING_X + PIPE_WIDTH, height);
		game.physics.arcade.enable(scoreWall);
		game.physics.arcade.enable(scoreWall);
		scoreWall.body.velocity.x = PIPE_VELOCITY_X;
		scoreWall.height = PIPE_GAP;

	}

	function touchedPipe() {

		if (!isRunning)return;

		ground.autoScroll(0, 0);
		isRunning = false;

		game.time.events.remove(timer);
		pipes.setAll('body.velocity.x', 0, true);
		scoreWalls.setAll('body.velocity.x', 0, true);
		bird.animations.stop();

		game.time.events.add(500,menu);

	}

	function clicked() {
		console.log('clicik')
		if (playButton.visible) return;

		if(!isRunning)startGame()
		bird.body.velocity.y = BIRD_VELOCITY_Y;
	//   jump_sound.play();


	}


	function startGame () {

			console.log('Starting game');
			timer = game.time.events.loop(spawnTime, addPipes);
			isRunning = true;
			bird.body.moves = true;


	}

	function resetGame () {

			console.log('Reseting game');
			resetBird()
			pipes.forEachAlive(killObj);
			scoreWalls.forEachAlive(killObj);
			ground.autoScroll(GROUND_SCROLL_SPEED, 0);
			playButton.visible = false;
			clickListener.active = true;




	}

	function resetBird () {

			bird.animations.play('fly');
			bird.body.moves = false;
			bird.reset(game.width / 2, game.height / 2);
			bird.angle = 0;


	}

	function menu () {

		//  Add and update the score
		score = 0;
		scoreText.text = score;
		playButton.visible = true;
		clickListener.active = false;

	}

	function scoreIncr(bird, scoreWall) {

		scoreWall.kill();
		score += 1;
		scoreText.text = score;
	}

	function killObj(obj) {
		obj.kill();
		obj.body.destroy();
	}

	function render() {

		pipes.forEachAlive(renderBody,this);
		scoreWalls.forEachAlive(renderBody,this);
		renderBody(ground)
	}

	function renderBody(obj) {
			game.debug.body(obj)
			//game.debug.body(obj,'rgba('+game.rnd.integerInRange(1,255)+','+game.rnd.integerInRange(1,255)+','+game.rnd.integerInRange(1,255)+',1)');
	}


}());

</script>

</body>
</html>
